  name: CI

  on:
    push:
      branches: [ main ]
    pull_request:
      branches: [ main ]

  jobs:
    dependances:
      runs-on: ubuntu-latest
      steps:
        - name: Checkout repo 
          uses: actions/checkout@v4

        - name: Setup Node and CACHE 
          uses: actions/setup-node@v4 
          with: 
            node-version: '20'
            cache: 'npm'
            cache-dependency-path: backend/package-lock.json
        
        - name: Install backend dependencies
          working-directory: ./backend
          run: npm ci

        - name: Save node_modules to cache 
          uses: actions/cache@v3
          id: node-cache
          with:
            path: backend/node_modules
            key: node-modules-${{ github.sha }}-${{ github.run_id }}
            restore-keys: node-modules-

    lint:
      runs-on: ubuntu-latest
      needs: dependances
      steps:
        - name: Checkout repo 
          uses: actions/checkout@v4

        - name: Setup Node 
          uses: actions/setup-node@v4 
          with: 
            node-version: '20'
            cache: 'npm'
            cache-dependency-path: backend/package-lock.json

        - name: Restore node_modules cache
          uses: actions/cache@v3
          id: node-cache-lint
          with:
            path: backend/node_modules
            key: node-modules-${{ github.sha }}-${{ github.run_id }}
            restore-keys: |
              node-modules-

        - name: Install if cache missed (pour la s√©curit√©)
          working-directory: ./backend
          if: steps.node-cache-lint.outputs.cache-hit != 'true'
          run: npm ci

        - name : "define working directory "
          working-directory: ./backend
          run: npm run lint

    test:
      runs-on: ubuntu-latest
      needs: lint
      steps:
        - name: Checkout repo 
          uses: actions/checkout@v4

        - name: Setup Node 
          uses: actions/setup-node@v4 
          with: 
            node-version: '20'
            cache: 'npm'
            cache-dependency-path: backend/package-lock.json

        - name: Restore node_modules cache
          uses: actions/cache@v3 
          id: node-cache-test
          with:
            path: backend/node_modules
            key: node-modules-${{ github.sha }}-${{ github.run_id }}
            restore-keys: |
              node-modules-

        - name: Install if cache missed (pour la s√©curit√©)
          working-directory: ./backend
          if: steps.node-cache-test.outputs.cache-hit != 'true'
          run: npm ci
              
        - name : "define working directory "
          working-directory: ./backend
          run: npm run test

    docker-build:
      runs-on: ubuntu-latest
      needs: test

      # permission pour cache
      permissions:
        contents: read
        packages: write
        actions: write

      steps:
        - name: Checkout repository
          uses: actions/checkout@v4

        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v3
    
        - name: Build Docker image with cache
          uses: docker/build-push-action@v5
          with:
            context: ./backend
            push: false
            tags: ci-training:${{ github.sha }}
            cache-from: type=gha
            cache-to: type=gha,mode=max


        - name: Save Docker image as artefact
          run: docker save ci-training:${{ github.sha }} | gzip > image.tar.gz

        - name: Test built image
          run: |
            echo "üîç Testing Docker image..."
            docker images ci-training:${{ github.sha }}
            echo ""
            echo "üì¶ Image details:"
            docker inspect ci-training:${{ github.sha }} | grep -A5 "Size"
            echo ""
            echo "üöÄ Running container test:"
            docker run --rm ci-training:${{ github.sha }} \
              node -e "console.log('‚úÖ Image works! Process running as:', process.getuid())"
      
        - name: Upload Docker image artefact
          uses: actions/upload-artifact@v4
          with:
            name: docker-image 
            path: image.tar.gz
            retention-days: 2

    render-health-check:
      runs-on: ubuntu-latest
      needs: docker-build
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      
      steps:        
        - name: V√©rifier l'application d√©ploy√©e
          run: |
            RENDER_URL="https://ci-training-app.onrender.com"
            sleep 10
            # HEALTH
            if curl -s -f "$RENDER_URL/health" > /dev/null; then
              echo "L'application est en ligne sur Render !"
              echo " URL: $RENDER_URL"
            else
              echo "L'application ne r√©pond pas encore"
              echo "V√©rifie les logs sur Render dashboard"
            fi
            

