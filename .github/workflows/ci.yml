  name: CI

  on:
    push:
      branches: [ main ]
    pull_request:
      branches: [ main ]

  jobs:
    dependances:
      runs-on: ubuntu-latest
      steps:
        - name: Checkout repo 
          uses: actions/checkout@v3 

        - name: Setup Node and CACHE 
          uses: actions/setup-node@v3 
          with: 
            node-version: '20'
            cache: 'npm'
            cache-dependency-path: backend/package-lock.json
        
        - name: Install backend dependencies
          working-directory: ./backend
          run: npm install
          

    validate-dependencies:
      runs-on: ubuntu-latest
      needs: dependances
      steps:
      - name: Checkout repo 
        uses: actions/checkout@v3 
      
      - name: Setup Node for BACKEND
        uses: actions/setup-node@v3 
        with: 
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'backend/package-lock.json'
      
      - name: Test npm ci
        working-directory: ./backend
        run: npm install


    lint:
      runs-on: ubuntu-latest
      needs: validate-dependencies
      steps:
        - name: Checkout repo 
          uses: actions/checkout@v3 

        - name: Setup Node 
          uses: actions/setup-node@v3 
          with: 
            node-version: '20'
            cache: 'npm'
            cache-dependency-path: backend/package-lock.json

        - name : "define working directory "
          working-directory: ./backend
          run: npm run lint

    test:
      runs-on: ubuntu-latest
      needs: lint
      steps:
        - name: Checkout repo 
          uses: actions/checkout@v3 

        - name: Setup Node 
          uses: actions/setup-node@v3 
          with: 
            node-version: '20'
            cache: 'npm'
            cache-dependency-path: backend/package-lock.json
              
        - name : "define working directory "
          working-directory: ./backend
          run: npm run test

    docker-build:
      runs-on: ubuntu-latest
      needs: test
      steps:
        - name: Checkout repository
          uses: actions/checkout@v4
        
        - name: Build Docker image
          run: |
            # CrÃ©ation de l'image
            cd backend
            docker build -t ci-training:${{ github.sha }} .
            
            # Test rapide dans le conteneur
            docker run --rm ci-training:${{ github.sha }} \
              node -e "console.log(' Docker image works ! ')"

        - name: Save Docker image as artefact
          run: docker save ci-training:${{ github.sha }} | gzip > image.tar.gz
      
        - name: Upload Docker image artefact
          uses: actions/upload-artifact@v4
          with:
            name: docker-image 
            path: image.tar.gz
            retention-days: 1

    render-health-check:
      runs-on: ubuntu-latest
      needs: docker-build
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      
      steps:
        - name: Attendre le dÃ©ploiement Render
          run: |
            echo "â³ Attente du dÃ©ploiement Render (30 secondes)..."
            sleep 30
        
        - name: VÃ©rifier l'application dÃ©ployÃ©e
          run: |
            # Remplace par ton URL Render
            RENDER_URL="https://ci-training.onrender.com"
            
            # Essaye de contacter l'app
            if curl -s -f "$RENDER_URL/health" > /dev/null; then
              echo "âœ… L'application est en ligne sur Render !"
              echo "ğŸŒ URL: $RENDER_URL"
            else
              echo "âš ï¸  L'application ne rÃ©pond pas encore"
              echo "ğŸ“Š VÃ©rifie les logs sur Render dashboard"
            fi
            

